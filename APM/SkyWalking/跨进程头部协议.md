# SkyWalking 跨进程传播的头部协议

- 1.0 版本

SkyWalking 不仅是一个普通的分布式追踪系统, 更是一个应用性能监控(APM)系统. 因此其头部信息与它们在改进分析性能的收集器中相比要更加复杂. 你可以在其他商业应用性能监控系统中找到许多相似的机制(其中某些甚至比 SkyWalking 更复杂).

# 头部项

- 头部名称: `sw3`
- 头部值: 通过 `|` 分割, 各部分如下:

**此头部协议来自 SkyWalking 3, 直到 2017 年, 因此头部名称 sw3 沿用至今.**

## 值

- 追踪段 ID

追踪段 ID 是分布式追踪中某一部分的唯一标识. 每一个 ID 只能在一个线程中使用. 此 ID 包含了 3 部分(long 类型数值), 如 `"1.2343.234234234`

1. 第一部分表示应用实例 ID, 由收集器赋值. (基本上就是一个 int 数值, 在 protobuf 中比较有用)
2. 第二部分表示线程 ID. (在 Java 中很可能是一个 int 数值, 在 protobuf 中比较有用)
3. 第三部分又分为两部分
   1. 一个时间戳, 单位毫秒
   2. 一个序列号, 在本线程中, 从 0 (包含 0) 到 9999 (包含 9999)

如果你在使用其他编程语言, 你可以自己生成你的 ID, 但是确保它是唯一的, 且包含以上三部分内容.

- Span ID

一个整数, 在一个追踪段中唯一, 从 0 开始;

- 父应用实例

父节点的实例 ID, 如: 对于一个 RPC 服务来说, ID 是来自客户端应用实例的 ID.

- 入口应用实例

入口应用的实例 ID. 如: 一个分布式追踪 `A->B->C`, 此 ID 为 `A` 的 ID.

- 对等主机

对等主机/对等 ID 来自客户端. 如: 客户端使用 `182.14.39.1:9080` 来访问服务器, 此 ip:port 就是对等主机.

**该值可以使用压缩收集器服务来获得一个 id(整数) 来代表这个字符串, 如果你使用字符串, 则字符串必须以 # 开始, 否则直接使用整数 ID.**

- 第一个追踪段的入口 Span 操作名称

从 **入口应用实例** 传播过来的入口 Span 的操作名称/id

**该值可以使用压缩收集器服务来获得一个 id(整数) 来代表这个字符串, 如果你使用字符串, 则字符串必须以 # 开始, 否则直接使用整数 ID.**

- 父追踪段的入口 Span 操作名称

从 **父应用实例** 传播过来的入口 Span 的操作名称/id

**该值可以使用压缩收集器服务来获得一个 id(整数) 来代表这个字符串, 如果你使用字符串, 则字符串必须以 # 开始, 否则直接使用整数 ID.**

- 分布式追踪 ID

整个链路追踪中的分布式追踪 ID, 如果在一个批处理进程中, 则它来自第一个批处理生产者的追踪. 组成部分与 **追踪段 ID** 一样, 包含三个部分.

### 示例值

1. `1.2343.234234234|1|1|1|#127.0.0.1:8080|#/portal/|#/testEntrySpan|1.2343.234234234`
2. `1.2343.234234234|1|1|1|#127.0.0.1:8080|#/portal/|1038|1.2343.234234234`



- 版本 2.0

## 摘要

SkyWalking 跨进程传播的头部协议版本 2.0 也叫做 sw6 协议. 第二版的协议与[第一版协议(亦即 sw3)](https://github.com/SkyAPM/document-cn-translation-of-skywalking/blob/master/docs/zh/6.2.0/protocols/Skywalking-Cross-Process-Propagation-Headers-Protocol-v1.md)有相同的目的, 就是确保上下文得以正常传播.

## 与版本 v1 的差异

两个版本的差异主要来自 SkyWalking 的演进, 包括

1. 服务网格和语言并不总是一样, 头部中的某些信息应该是可选的
2. 需要 BASE64 编码
3. 包括了采样标记

## 头部项

- 头部名称: `sw6`
- 头部值: 由 `-` 分割, 各部分如下. 头部值的最大长度(默认)应该小于 2k.

值格式示例, `XXXXX-XXXXX-XXXX-XXXX`

## 值

头部值包含以下段, 所有字符串类型的值都是 BASE64 编码的.

- 必须项

1. 采样(Sample). 0 或 1. 0 表示上下文存在, 但是可以(也很可能)忽略. 1 表示此追踪需要采样并发送到后端.
2. 追踪标识(Trace Id). **字符串(BASE64 编码)**. 由 `.` 分割的三个 long 类型值, 表示此追踪的唯一标识.
3. 父追踪段 ID(Parent trace segment Id). **字符串(BASE64 编码)**. 由 `.` 分割的三个 long 类型值, 表示父服务中的追踪段的唯一标识.
4. 父 Span 标识(Parent span Id). 整数. 从 0 开始. 此 Span ID 指向了父追踪段中的 Span.
5. 父服务实例标识(Parent service instance Id). 整数. 父服务的实例 ID.
6. 入口服务实例标识(Entrance service instance Id). 整数. 入口服务的实例 ID.
7. 本请求的目标地址(Target address of this request). **字符串(BASE64 编码)**. 客户端用于访问目标服务的网络地址(不一定是 IP + 端口). **该值可以使用压缩收集器服务来获得一个 id(整数) 来代表这个字符串, 如果你使用字符串, 则字符串必须以 # 开始, 否则直接使用整数 ID.**

- 可选项

当代理/SDK 没有这些信息时, 或者头部大于阈值(默认 2k)时, 可选项可以不存在头部值中

1. 追踪的入口端点. **字符串(BASE64 编码)**. **该值可以使用压缩收集器服务来获得一个 id(整数) 来代表这个字符串, 如果你使用字符串, 则字符串必须以 # 开始, 否则直接使用整数 ID.**
2. 父服务的端点. **字符串(BASE64 编码)**. **该值可以使用压缩收集器服务来获得一个 id(整数) 来代表这个字符串, 如果你使用字符串, 则字符串必须以 # 开始, 否则直接使用整数 ID.**

## 示例

1. 简单版本, `1-TRACEID-SEGMENTID-3-5-2-IPPORT`
2. 完整版本 `1-TRACEID-SEGMENTID-3-5-2-IPPORT-ENTRYURI-PARENTURI`